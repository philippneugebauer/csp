<% content_for :title, @customer.name %>

<div class="container py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
      <h1 class="h2 mb-0"><%= @customer.name %></h1>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <%= link_to customers_path, class: "btn btn-outline-primary" do %>
        <i class="bi bi-arrow-left me-1"></i>Back
      <% end %>
      <button
        class="btn btn-outline-primary"
        type="button"
        data-bs-toggle="modal"
        data-bs-target="#uploadDocumentModal"
      >
        <i class="bi bi-file-earmark-arrow-up me-1"></i>Upload document
      </button>
      <button
        class="btn btn-outline-primary"
        type="button"
        data-bs-toggle="modal"
        data-bs-target="#addGmvModal"
      >
        <i class="bi bi-graph-up-arrow me-1"></i>Add GMV
      </button>
      <%= link_to gmv_trend_customer_path(@customer), class: "btn btn-outline-success" do %>
        <i class="bi bi-graph-up me-1"></i>GMV chart
      <% end %>
      <%= button_to sync_emails_customer_path(@customer), method: :post, class: "btn btn-outline-secondary" do %>
        <i class="bi bi-envelope-arrow-down me-1"></i>Sync Gmail
      <% end %>
      <%= link_to edit_customer_path(@customer), class: "btn btn-outline-warning" do %>
        <i class="bi bi-pencil-square me-1"></i>Edit
      <% end %>
      <%= link_to history_customer_path(@customer), class: "btn btn-outline-info" do %>
        <i class="bi bi-clock-history me-1"></i>History
      <% end %>
      <%= button_to @customer, method: :delete, class: "btn btn-outline-danger", form: { class: "d-inline" } do %>
        <i class="bi bi-trash me-1"></i>Delete
      <% end %>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-2">
          <div class="text-body-secondary small">Organization ID</div>
          <div class="fw-semibold"><%= @customer.organization_id.presence || "-" %></div>
        </div>
        <div class="col-md-2">
          <div class="text-body-secondary small">Segment</div>
          <div class="fw-semibold"><span class="badge text-bg-dark"><%= @customer.customer_segment_label %></span></div>
        </div>
        <div class="col-md-2">
          <div class="text-body-secondary small">Stage</div>
          <div class="fw-semibold"><span class="badge text-bg-secondary"><%= @customer.stage.humanize %></span></div>
        </div>
        <div class="col-md-2">
          <div class="text-body-secondary small">Churn risk</div>
          <% risk_badge_class = @customer.high? ? "text-bg-danger" : @customer.medium? ? "text-bg-warning" : "text-bg-success" %>
          <div class="fw-semibold"><span class="badge <%= risk_badge_class %>"><%= @customer.churn_risk.humanize %></span></div>
        </div>
        <div class="col-md-2">
          <div class="text-body-secondary small">Travel budget</div>
          <div class="fw-semibold"><%= @customer.travel_budget.present? ? number_to_currency(@customer.travel_budget) : "-" %></div>
        </div>
        <div class="col-md-2">
          <div class="text-body-secondary small">Customer Success Manager</div>
          <div class="fw-semibold">
            <%= link_to @customer.customer_success_manager.full_name, customer_success_manager_path(@customer.customer_success_manager), class: "link-primary text-decoration-none" %>
          </div>
        </div>
        <div class="col-md-3">
          <div class="text-body-secondary small">Contract period</div>
          <div class="fw-semibold">
            <% if @customer.contract_start_date.present? || @customer.contract_termination_date.present? %>
              <%= @customer.contract_start_date.present? ? l(@customer.contract_start_date) : "?" %>
              -
              <%= @customer.contract_termination_date.present? ? l(@customer.contract_termination_date) : "?" %>
            <% else %>
              -
            <% end %>
          </div>
        </div>
        <div class="col-md-3">
          <div class="text-body-secondary small">Contact persons</div>
          <% if @customer.customer_contacts.any? %>
            <div class="fw-semibold">
              <% @customer.customer_contacts.each do |person| %>
                <div><%= person.name %> (<%= person.email %>)</div>
              <% end %>
            </div>
          <% else %>
            <div class="fw-semibold">-</div>
          <% end %>
        </div>
        <div class="col-md-3">
          <div class="text-body-secondary small">Monthly engagement</div>
          <% monthly_percentage = @customer.monthly_engagement_percentage %>
          <% monthly_target = @customer.travel_budget.present? ? (@customer.travel_budget.to_d / 12) : nil %>
          <div class="fw-semibold">
            <% if monthly_percentage.present? && monthly_target.present? %>
              <%= number_to_percentage(monthly_percentage, precision: 1) %>
              <div class="small text-body-secondary">
                <%= number_to_currency(@customer.monthly_gmv_total) %> / <%= number_to_currency(monthly_target) %>
              </div>
            <% else %>
              -
            <% end %>
          </div>
        </div>
        <div class="col-md-3">
          <div class="text-body-secondary small">Quarterly engagement</div>
          <% quarterly_percentage = @customer.quarterly_engagement_percentage %>
          <% quarterly_target = @customer.travel_budget.present? ? (@customer.travel_budget.to_d / 4) : nil %>
          <div class="fw-semibold">
            <% if quarterly_percentage.present? && quarterly_target.present? %>
              <%= number_to_percentage(quarterly_percentage, precision: 1) %>
              <div class="small text-body-secondary">
                <%= number_to_currency(@customer.quarterly_gmv_total) %> / <%= number_to_currency(quarterly_target) %>
              </div>
            <% else %>
              -
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center gap-2">
      <span class="fw-semibold">Task</span>
      <div class="d-flex align-items-center gap-2">
        <% if @show_completed_tasks %>
          <%= link_to customer_path(@customer, request.query_parameters.except("show_completed_tasks")), class: "btn btn-sm btn-outline-secondary" do %>
            Hide completed
          <% end %>
        <% else %>
          <%= link_to customer_path(@customer, request.query_parameters.merge("show_completed_tasks" => "1")), class: "btn btn-sm btn-outline-secondary" do %>
            Show completed
          <% end %>
        <% end %>
        <button
          class="btn btn-sm btn-outline-primary"
          type="button"
          data-bs-toggle="modal"
          data-bs-target="#addTaskModal"
        >
          <i class="bi bi-list-check me-1"></i>Add task
        </button>
      </div>
    </div>
    <ul class="list-group list-group-flush">
      <% @task_activities.each do |task| %>
        <li class="list-group-item d-flex justify-content-between align-items-start gap-3">
          <div>
            <div class="mb-1 d-flex align-items-center gap-2">
              <span class="badge <%= task.completed? ? "text-bg-success" : "text-bg-dark" %>">
                <%= task.completed? ? "Completed" : "Task" %>
              </span>
              <% if task.completed_at.present? %>
                <span class="small text-body-secondary">Completed <%= l(task.completed_at, format: :short) %></span>
              <% end %>
            </div>
            <div class="<%= task.completed? ? "text-decoration-line-through text-body-secondary" : "" %>"><%= simple_format(task.body) %></div>
            <div class="small text-body-secondary"><%= task.customer_success_manager.full_name %></div>
          </div>
          <div class="d-flex align-items-start gap-2">
            <% unless task.completed? %>
              <%= button_to complete_customer_customer_task_path(@customer, task, request.query_parameters.slice("activity_type", "email_direction", "show_completed_tasks")),
                method: :patch,
                class: "btn btn-sm btn-outline-success",
                form: { class: "d-inline" } do %>
                Complete
              <% end %>
            <% end %>
            <div class="small text-body-secondary text-nowrap"><%= l(task.occurred_at, format: :short) %></div>
          </div>
        </li>
      <% end %>
      <% if @task_activities.empty? %>
        <li class="list-group-item text-body-secondary">
          <%= @show_completed_tasks ? "No tasks yet." : "No open tasks." %>
        </li>
      <% end %>
    </ul>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-header bg-body-tertiary fw-semibold">Add note</div>
    <div class="card-body">
      <%= form_with(url: customer_customer_notes_path(@customer), scope: :customer_note, data: { turbo_temporary: true }) do |form| %>
        <div class="row g-3">
          <div class="col-12">
            <%= form.text_area :body, class: "form-control", rows: 3, required: true, placeholder: "Add a note...", autocomplete: "off", data: { turbo_temporary: true } %>
          </div>
        </div>
        <div class="mt-3">
          <%= form.submit "Add note", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="card shadow-sm overflow-hidden">
    <div class="card-header bg-body-tertiary d-flex flex-wrap justify-content-between align-items-center gap-2">
      <span class="fw-semibold">Customer activity</span>
      <div class="btn-group btn-group-sm" role="group" aria-label="Activity type filter">
        <%= link_to "All", customer_path(@customer, activity_type: "all", email_direction: @email_direction), class: "btn #{@activity_type == "all" ? "btn-primary" : "btn-outline-primary"}" %>
        <%= link_to "Notes", customer_path(@customer, activity_type: "notes"), class: "btn #{@activity_type == "notes" ? "btn-primary" : "btn-outline-primary"}" %>
        <%= link_to "Documents", customer_path(@customer, activity_type: "documents"), class: "btn #{@activity_type == "documents" ? "btn-primary" : "btn-outline-primary"}" %>
        <%= link_to "GMV", customer_path(@customer, activity_type: "gmv"), class: "btn #{@activity_type == "gmv" ? "btn-primary" : "btn-outline-primary"}" %>
        <%= link_to "Emails", customer_path(@customer, activity_type: "emails", email_direction: "all"), class: "btn #{@activity_type == "emails" && @email_direction == "all" ? "btn-primary" : "btn-outline-primary"}" %>
        <%= link_to "Inbound", customer_path(@customer, activity_type: "emails", email_direction: "inbound"), class: "btn #{@activity_type == "emails" && @email_direction == "inbound" ? "btn-primary" : "btn-outline-primary"}" %>
        <%= link_to "Outbound", customer_path(@customer, activity_type: "emails", email_direction: "outbound"), class: "btn #{@activity_type == "emails" && @email_direction == "outbound" ? "btn-primary" : "btn-outline-primary"}" %>
      </div>
    </div>

    <div class="list-group list-group-flush">
      <% @activities.each do |activity| %>
        <% if activity.is_a?(NoteActivity) %>
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div>
                <div class="mb-1">
                  <span class="badge <%= activity.documents.attached? ? "text-bg-primary" : "text-bg-secondary" %>">
                    <%= activity.documents.attached? ? "Document" : "Note" %>
                  </span>
                </div>
                <div><%= simple_format(activity.body) %></div>
                <div class="small text-body-secondary"><%= activity.customer_success_manager.full_name %></div>
                <% if activity.documents.attached? %>
                  <div class="small mt-2">
                    <% activity.documents.each do |document| %>
                      <%= link_to document.filename.to_s, url_for(document), class: "link-primary me-3", target: "_blank", rel: "noopener" %>
                    <% end %>
                  </div>
                <% end %>
              </div>
              <div class="small text-body-secondary text-nowrap"><%= l(activity.occurred_at, format: :short) %></div>
            </div>
          </div>
        <% elsif activity.is_a?(EmailActivity) %>
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div class="w-100">
                <div class="d-flex flex-wrap gap-2 mb-1">
                  <span class="badge text-bg-info">Email</span>
                  <% direction_class = activity.inbound? ? "text-bg-info" : "text-bg-primary" %>
                  <span class="badge <%= direction_class %>"><%= activity.direction.humanize %></span>
                </div>
                <div class="fw-semibold"><%= activity.subject.presence || "(no subject)" %></div>
                <% if activity.snippet.present? %>
                  <div class="small text-body-secondary mb-1"><%= activity.snippet %></div>
                <% end %>
                <div class="small text-body-secondary">
                  <strong>From:</strong> <%= activity.from_email %> Â· <strong>To:</strong> <%= activity.to_email %>
                </div>
                <% if activity.documents.attached? %>
                  <div class="small mt-2">
                    <% activity.documents.each do |document| %>
                      <%= link_to document.filename.to_s, url_for(document), class: "link-primary me-3", target: "_blank", rel: "noopener" %>
                    <% end %>
                  </div>
                <% end %>
              </div>
              <div class="small text-body-secondary text-nowrap"><%= l(activity.occurred_at, format: :short) %></div>
            </div>
          </div>
        <% elsif activity.is_a?(GmvActivity) %>
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div class="w-100">
                <div class="d-flex flex-wrap gap-2 mb-1">
                  <span class="badge text-bg-success">GMV</span>
                </div>
                <div class="fw-semibold"><%= number_to_currency(activity.gmv_revenue) %></div>
                <div class="small text-body-secondary">Revenue date: <%= l(activity.gmv_on) %></div>
                <div class="small text-body-secondary"><%= activity.customer_success_manager.full_name %></div>
              </div>
              <div class="small text-body-secondary text-nowrap"><%= l(activity.occurred_at, format: :short) %></div>
            </div>
          </div>
        <% end %>
      <% end %>

      <% if @activities.empty? %>
        <div class="list-group-item text-body-secondary">No activity found for this filter.</div>
      <% end %>
    </div>
  </div>
</div>

<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title fs-5" id="uploadDocumentModalLabel">Upload document activity</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with(
          url: customer_customer_documents_path(@customer),
          scope: :customer_document,
          data: {
            turbo_temporary: true,
            controller: "transient-form",
            action: "turbo:submit-end->transient-form#resetOnSuccess turbo:before-cache@document->transient-form#reset"
          }
        ) do |form| %>
          <div class="row g-3">
            <div class="col-12">
              <%= form.label :documents, "Documents", class: "form-label" %>
              <%= form.file_field :documents, multiple: true, required: true, class: "form-control", direct_upload: true, data: { turbo_temporary: true } %>
            </div>
            <div class="col-12">
              <%= form.label :comment, "Comment (optional)", class: "form-label" %>
              <%= form.text_area :comment, rows: 3, class: "form-control", placeholder: "Add context for this upload...", autocomplete: "off", data: { turbo_temporary: true } %>
            </div>
          </div>
          <div class="mt-3 d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <%= form.submit "Add document activity", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title fs-5" id="addTaskModalLabel">Add task</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with(
          url: customer_customer_tasks_path(@customer),
          scope: :customer_task,
          data: {
            turbo_temporary: true,
            controller: "transient-form",
            action: "turbo:submit-end->transient-form#resetOnSuccess turbo:before-cache@document->transient-form#reset"
          }
        ) do |form| %>
          <div class="row g-3">
            <div class="col-12">
              <%= form.label :body, "Task", class: "form-label" %>
              <%= form.text_area :body, class: "form-control", rows: 3, required: true, placeholder: "Add a task...", autocomplete: "off", data: { turbo_temporary: true } %>
            </div>
          </div>
          <div class="mt-3 d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <%= form.submit "Add task", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addGmvModal" tabindex="-1" aria-labelledby="addGmvModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title fs-5" id="addGmvModalLabel">Add GMV activity</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with(
          url: customer_customer_gmv_activities_path(@customer),
          scope: :customer_gmv_activity,
          data: {
            turbo_temporary: true,
            controller: "transient-form",
            action: "turbo:submit-end->transient-form#resetOnSuccess turbo:before-cache@document->transient-form#reset"
          }
        ) do |form| %>
          <div class="row g-3">
            <div class="col-12">
              <%= form.label :gmv_on, "Revenue date", class: "form-label" %>
              <%= form.date_field :gmv_on, required: true, class: "form-control", value: Date.current, data: { turbo_temporary: true } %>
            </div>
            <div class="col-12">
              <%= form.label :gmv_revenue, "GMV revenue", class: "form-label" %>
              <%= form.number_field :gmv_revenue, required: true, min: 0, step: "0.01", class: "form-control", placeholder: "0.00", data: { turbo_temporary: true } %>
            </div>
          </div>
          <div class="mt-3 d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <%= form.submit "Add GMV", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
